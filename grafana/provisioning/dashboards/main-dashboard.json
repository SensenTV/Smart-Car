{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": { "type": "grafana", "uid": "-- Grafana --" },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "links": [],
  "panels": [
    {
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "id": 100,
      "panels": [],
      "title": "Uebersicht",
      "type": "row"
    },
    {
      "datasource": { "type": "influxdb", "uid": "influxdb" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] }
        },
        "overrides": []
      },
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 1 },
      "id": 1,
      "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
      "title": "Aktive Fahrzeuge",
      "type": "stat",
      "targets": [
        {
          "datasource": { "type": "influxdb", "uid": "influxdb" },
          "query": "from(bucket: \"vehicle_data\")\n  |> range(start: -1h)\n  |> filter(fn: (r) => r._measurement == \"vehicle_state\")\n  |> filter(fn: (r) => r._field == \"online\")\n  |> group(columns: [\"vehicle_id\"])\n  |> last()\n  |> group()\n  |> count()\n  |> map(fn: (r) => ({r with _value: r._value}))",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": { "type": "influxdb", "uid": "influxdb" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 1 }] }
        },
        "overrides": []
      },
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 1 },
      "id": 2,
      "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
      "title": "Aktive Fehler",
      "type": "stat",
      "targets": [
        {
          "datasource": { "type": "influxdb", "uid": "influxdb" },
          "query": "from(bucket: \"vehicle_data\")\n  |> range(start: -24h)\n  |> filter(fn: (r) => r._measurement == \"vehicle_errors\")\n  |> filter(fn: (r) => r._field == \"active\")\n  |> group(columns: [\"vehicle_id\", \"error_code\"])\n  |> last()\n  |> filter(fn: (r) => r._value == 1)\n  |> group()\n  |> count()\n  |> yield(name: \"count\")",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": { "type": "influxdb", "uid": "influxdb" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "blue", "value": null }] }
        },
        "overrides": []
      },
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 1 },
      "id": 3,
      "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
      "title": "Fahrten 24h",
      "type": "stat",
      "targets": [
        {
          "datasource": { "type": "influxdb", "uid": "influxdb" },
          "query": "from(bucket: \"vehicle_data\")\n  |> range(start: -24h)\n  |> filter(fn: (r) => r._measurement == \"trip_summary\")\n  |> filter(fn: (r) => r._field == \"duration_s\")\n  |> group()\n  |> count()\n  |> yield(name: \"count\")",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": { "type": "influxdb", "uid": "influxdb" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "orange", "value": null }] }
        },
        "overrides": []
      },
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 1 },
      "id": 4,
      "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
      "title": "Alarme 24h",
      "type": "stat",
      "targets": [
        {
          "datasource": { "type": "influxdb", "uid": "influxdb" },
          "query": "from(bucket: \"vehicle_data\")\n  |> range(start: -24h)\n  |> filter(fn: (r) => r._measurement == \"alerts\")\n  |> filter(fn: (r) => r._field == \"message\")\n  |> group()\n  |> count()\n  |> yield(name: \"count\")",
          "refId": "A"
        }
      ]
    },
    {
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 },
      "id": 101,
      "panels": [],
      "title": "Fahrzeugdaten",
      "type": "row"
    },
    {
      "datasource": { "type": "influxdb", "uid": "influxdb" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "Liter", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 20, "gradientMode": "opacity", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 4, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": true, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "line" } },
          "displayName": "${__field.labels.vehicle_id}",
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "orange", "value": 10 }, { "color": "green", "value": 20 }] },
          "unit": "litre"
        },
        "overrides": []
      },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 6 },
      "id": 5,
      "options": { "legend": { "calcs": ["last", "min", "mean"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
      "title": "Kraftstoffstand",
      "type": "timeseries",
      "targets": [
        {
          "datasource": { "type": "influxdb", "uid": "influxdb" },
          "query": "from(bucket: \"vehicle_data\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"vehicle_state\")\n  |> filter(fn: (r) => r._field == \"fuel_l\")\n  |> group(columns: [\"vehicle_id\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": { "type": "influxdb", "uid": "influxdb" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "Volt", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 4, "scaleDistribution": { "type": "linear" }, "showPoints": "auto", "spanNulls": true, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "line" } },
          "displayName": "${__field.labels.vehicle_id}",
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "orange", "value": 11.5 }, { "color": "green", "value": 12.2 }] },
          "unit": "volt"
        },
        "overrides": []
      },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 6 },
      "id": 6,
      "options": { "legend": { "calcs": ["last", "min", "mean"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
      "title": "Batteriespannung",
      "type": "timeseries",
      "targets": [
        {
          "datasource": { "type": "influxdb", "uid": "influxdb" },
          "query": "from(bucket: \"vehicle_data\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"vehicle_state\")\n  |> filter(fn: (r) => r._field == \"battery_v\")\n  |> group(columns: [\"vehicle_id\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)",
          "refId": "A"
        }
      ]
    },
    {
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 14 },
      "id": 102,
      "panels": [],
      "title": "Listen",
      "type": "row"
    },
    {
      "datasource": { "type": "influxdb", "uid": "influxdb" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "custom": { "align": "auto", "cellOptions": { "type": "auto" }, "inspect": false, "filterable": false },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "vehicle_id" }, "properties": [{ "id": "displayName", "value": "Fahrzeug" }, { "id": "custom.width", "value": 120 }] },
          { "matcher": { "id": "byName", "options": "state" }, "properties": [{ "id": "displayName", "value": "Status" }, { "id": "mappings", "value": [{ "type": "value", "options": { "driving": { "text": "Faehrt", "color": "green" }, "parked": { "text": "Geparkt", "color": "blue" }, "idle": { "text": "Leerlauf", "color": "yellow" }, "offline": { "text": "Offline", "color": "gray" } } }] }] },
          { "matcher": { "id": "byName", "options": "fuel_l" }, "properties": [{ "id": "displayName", "value": "Kraftstoff" }, { "id": "unit", "value": "litre" }] },
          { "matcher": { "id": "byName", "options": "battery_v" }, "properties": [{ "id": "displayName", "value": "Batterie" }, { "id": "unit", "value": "volt" }] },
          { "matcher": { "id": "byName", "options": "_time" }, "properties": [{ "id": "displayName", "value": "Aktualisiert" }] }
        ]
      },
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 15 },
      "id": 7,
      "options": { "cellHeight": "sm", "footer": { "countRows": false, "fields": "", "reducer": ["sum"], "show": false }, "showHeader": true, "sortBy": [{ "desc": true, "displayName": "Aktualisiert" }] },
      "title": "Fahrzeugliste",
      "type": "table",
      "targets": [
        {
          "datasource": { "type": "influxdb", "uid": "influxdb" },
          "query": "from(bucket: \"vehicle_data\")\n  |> range(start: -1h)\n  |> filter(fn: (r) => r._measurement == \"vehicle_state\")\n  |> pivot(rowKey:[\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n  |> group(columns: [\"vehicle_id\"])\n  |> last(column: \"_time\")\n  |> keep(columns: [\"_time\", \"vehicle_id\", \"state\", \"fuel_l\", \"battery_v\"])",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": { "type": "influxdb", "uid": "influxdb" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "custom": { "align": "auto", "cellOptions": { "type": "auto" }, "inspect": false, "filterable": false },
          "mappings": [
            { "options": { "1": { "color": "red", "index": 0, "text": "AKTIV" } }, "type": "value" },
            { "options": { "0": { "color": "green", "index": 1, "text": "Geloest" } }, "type": "value" }
          ],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "vehicle_id" }, "properties": [{ "id": "displayName", "value": "Fahrzeug" }, { "id": "custom.width", "value": 100 }] },
          { "matcher": { "id": "byName", "options": "error_code" }, "properties": [{ "id": "displayName", "value": "Fehlercode" }] },
          { "matcher": { "id": "byName", "options": "active" }, "properties": [{ "id": "displayName", "value": "Status" }] },
          { "matcher": { "id": "byName", "options": "_time" }, "properties": [{ "id": "displayName", "value": "Zeit" }] }
        ]
      },
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 15 },
      "id": 8,
      "options": { "cellHeight": "sm", "footer": { "countRows": false, "fields": "", "reducer": ["sum"], "show": false }, "showHeader": true, "sortBy": [{ "desc": true, "displayName": "Zeit" }] },
      "title": "Fehlerliste",
      "type": "table",
      "targets": [
        {
          "datasource": { "type": "influxdb", "uid": "influxdb" },
          "query": "from(bucket: \"vehicle_data\")\n  |> range(start: -7d)\n  |> filter(fn: (r) => r._measurement == \"vehicle_errors\")\n  |> pivot(rowKey:[\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n  |> sort(columns: [\"_time\"], desc: true)\n  |> limit(n: 20)\n  |> keep(columns: [\"_time\", \"vehicle_id\", \"error_code\", \"active\"])",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": { "type": "influxdb", "uid": "influxdb" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "custom": { "align": "auto", "cellOptions": { "type": "auto" }, "inspect": false, "filterable": false },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "vehicle_id" }, "properties": [{ "id": "displayName", "value": "Fahrzeug" }, { "id": "custom.width", "value": 100 }] },
          { "matcher": { "id": "byName", "options": "trip_id" }, "properties": [{ "id": "displayName", "value": "Fahrt" }] },
          { "matcher": { "id": "byName", "options": "duration_s" }, "properties": [{ "id": "displayName", "value": "Dauer" }, { "id": "unit", "value": "s" }] },
          { "matcher": { "id": "byName", "options": "fuel_used" }, "properties": [{ "id": "displayName", "value": "Verbrauch" }, { "id": "unit", "value": "litre" }] },
          { "matcher": { "id": "byName", "options": "_time" }, "properties": [{ "id": "displayName", "value": "Datum" }] }
        ]
      },
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 21 },
      "id": 9,
      "options": { "cellHeight": "sm", "footer": { "countRows": false, "fields": "", "reducer": ["sum"], "show": false }, "showHeader": true, "sortBy": [{ "desc": true, "displayName": "Datum" }] },
      "title": "Letzte Fahrten",
      "type": "table",
      "targets": [
        {
          "datasource": { "type": "influxdb", "uid": "influxdb" },
          "query": "from(bucket: \"vehicle_data\")\n  |> range(start: -7d)\n  |> filter(fn: (r) => r._measurement == \"trip_summary\")\n  |> pivot(rowKey:[\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n  |> sort(columns: [\"_time\"], desc: true)\n  |> limit(n: 20)\n  |> keep(columns: [\"_time\", \"vehicle_id\", \"trip_id\", \"duration_s\", \"fuel_used\"])",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": { "type": "influxdb", "uid": "influxdb" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "custom": { "align": "auto", "cellOptions": { "type": "auto" }, "inspect": false, "filterable": false },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "orange", "value": null }] }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "vehicle_id" }, "properties": [{ "id": "displayName", "value": "Fahrzeug" }, { "id": "custom.width", "value": 100 }] },
          { "matcher": { "id": "byName", "options": "alert_type" }, "properties": [{ "id": "displayName", "value": "Typ" }] },
          { "matcher": { "id": "byName", "options": "message" }, "properties": [{ "id": "displayName", "value": "Nachricht" }] },
          { "matcher": { "id": "byName", "options": "_time" }, "properties": [{ "id": "displayName", "value": "Zeit" }] }
        ]
      },
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 21 },
      "id": 10,
      "options": { "cellHeight": "sm", "footer": { "countRows": false, "fields": "", "reducer": ["sum"], "show": false }, "showHeader": true, "sortBy": [{ "desc": true, "displayName": "Zeit" }] },
      "title": "Letzte Alarme",
      "type": "table",
      "targets": [
        {
          "datasource": { "type": "influxdb", "uid": "influxdb" },
          "query": "from(bucket: \"vehicle_data\")\n  |> range(start: -7d)\n  |> filter(fn: (r) => r._measurement == \"alerts\")\n  |> pivot(rowKey:[\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n  |> sort(columns: [\"_time\"], desc: true)\n  |> limit(n: 20)\n  |> keep(columns: [\"_time\", \"vehicle_id\", \"alert_type\", \"message\"])",
          "refId": "A"
        }
      ]
    },
    {
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 27 },
      "id": 103,
      "panels": [],
      "title": "Termine",
      "type": "row"
    },
    {
      "datasource": { "type": "grafana-googlesheets-datasource", "uid": "googlesheets" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "custom": { "align": "auto", "cellOptions": { "type": "auto" }, "inspect": false, "filterable": false },
          "mappings": [
            { "options": { "Geplant": { "color": "blue", "index": 0 } }, "type": "value" },
            { "options": { "In Bearbeitung": { "color": "yellow", "index": 1 } }, "type": "value" },
            { "options": { "Abgeschlossen": { "color": "green", "index": 2 } }, "type": "value" },
            { "options": { "Abgesagt": { "color": "red", "index": 3 } }, "type": "value" }
          ],
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Uhrzeit" }, "properties": [{ "id": "custom.width", "value": 80 }] },
          { "matcher": { "id": "byName", "options": "Fahrzeug" }, "properties": [{ "id": "custom.width", "value": 100 }] },
          { "matcher": { "id": "byName", "options": "Status" }, "properties": [{ "id": "custom.width", "value": 120 }] }
        ]
      },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 28 },
      "id": 11,
      "options": { "cellHeight": "sm", "footer": { "countRows": false, "fields": "", "reducer": ["sum"], "show": false }, "showHeader": true },
      "title": "Heutige Termine (Google Sheets)",
      "type": "table",
      "targets": [
        {
          "datasource": { "type": "grafana-googlesheets-datasource", "uid": "googlesheets" },
          "refId": "A",
          "spreadsheet": "",
          "range": "Termine!A:D",
          "cacheDurationSeconds": 300
        }
      ]
    }
  ],
  "refresh": "5s",
  "schemaVersion": 39,
  "tags": ["smart-car", "fleet", "overview"],
  "templating": { "list": [] },
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "timezone": "browser",
  "title": "Flottenuebersicht",
  "uid": "smart-car-main",
  "version": 1
}
